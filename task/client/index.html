<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stock Tracker</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #live, #history { border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
    label { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>ðŸ“ˆ Live Stock Prices</h2>
  <div id="live">
    <ul id="live-updates"></ul>
  </div>

  <h2>ðŸ“Š Historical Price Query</h2>
  <form id="query-form">
    <label>Stock Name:
      <input type="text" id="stock-name" required>
    </label>
    <label>Start Time (ISO):
      <input type="datetime-local" id="start-time">
    </label>
    <label>End Time (ISO):
      <input type="datetime-local" id="end-time">
    </label>
    <button type="submit">Query</button>
  </form>

  <div id="history">
    <h3>Results:</h3>
    <ul id="history-results"></ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/centrifuge@5.0.1/dist/centrifuge.min.js"></script>
  <script>
    // === Centrifugo WebSocket connection ===
    const centrifuge = new Centrifuge("ws://localhost:8000/connection/websocket");

    // Subscribe to both NASDAQ and NYSE
    const channels = ["NASDAQ", "NYSE"];
    const liveUpdates = document.getElementById("live-updates");

    channels.forEach(channel => {
      const sub = centrifuge.newSubscription(channel);

      sub.on("publication", ctx => {
        const data = ctx.data;
        const li = document.createElement("li");
        li.textContent = `[${channel}] ${data.stock}: $${data.price} at ${new Date(data.timestamp * 1000).toLocaleTimeString()}`;
        liveUpdates.prepend(li);
        if (liveUpdates.children.length > 50) liveUpdates.removeChild(liveUpdates.lastChild); // limit list size
      });

      sub.subscribe();
    });

    centrifuge.connect();

    // === Historical Query ===
    const form = document.getElementById("query-form");
    const results = document.getElementById("history-results");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      results.innerHTML = "<li>Loading...</li>";

      const stock = document.getElementById("stock-name").value;
      const start = document.getElementById("start-time").value;
      const end = document.getElementById("end-time").value;

      const params = new URLSearchParams();
      if (start) params.append("start_time", new Date(start).toISOString());
      if (end) params.append("end_time", new Date(end).toISOString());

      try {
        const res = await fetch(`http://localhost:5000/api/prices/${stock}?${params.toString()}`);
        const data = await res.json();
        results.innerHTML = "";

        if (data.length === 0) {
          results.innerHTML = "<li>No results found.</li>";
        } else {
          data.forEach(point => {
            const li = document.createElement("li");
            li.textContent = `$${point.price} at ${new Date(point.timestamp).toLocaleString()}`;
            results.appendChild(li);
          });
        }
      } catch (err) {
        results.innerHTML = `<li>Error fetching data: ${err}</li>`;
      }
    });
  </script>
</body>
</html>

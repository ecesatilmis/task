<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stock Tracker</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #live, #history { border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
    label { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Live Stock Prices</h2>
  <div id="live">
    <ul id="live-updates"></ul>
  </div>

  <h2>Historical Price Query</h2>
  <form id="query-form">
    <label>Stock Name:
      <input type="text" id="stock-name" required>
    </label>
    <label>Start Time (ISO):
      <input type="datetime-local" id="start-time">
    </label>
    <label>End Time (ISO):
      <input type="datetime-local" id="end-time">
    </label>
    <button type="submit">Query</button>
  </form>

  <div id="history">
    <h3>Results:</h3>
    <ul id="history-results"></ul>
    <h4 id="average-price"></h4>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/centrifuge@5.0.1/dist/centrifuge.min.js"></script>
  <script>
    // WebSocket (Centrifugo)
    const centrifuge = new Centrifuge("ws://" + location.host + "/connection/websocket");

    // Subscribe to both NASDAQ and NYSE
    const channels = ["NASDAQ", "NYSE"];
    const liveUpdates = document.getElementById("live-updates");

    channels.forEach(channel => {
      const sub = centrifuge.newSubscription(channel);

      sub.on("publication", ctx => {
        const data = ctx.data;
        const li = document.createElement("li");
        li.textContent = `[${channel}] ${data.stock}: $${data.price} at ${new Date(data.timestamp * 1000).toLocaleTimeString()}`;
        liveUpdates.prepend(li);
        if (liveUpdates.children.length > 50) liveUpdates.removeChild(liveUpdates.lastChild); // limit list size
      });

      sub.subscribe();
    });

    centrifuge.connect();

    // Historical Query
    const form = document.getElementById("query-form");
    const results = document.getElementById("history-results");
    const avgDisplay = document.getElementById("average-price");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      results.innerHTML = "<li>Loading price data...</li>";
      avgDisplay.textContent = "Calculating average...";

      const stock = document.getElementById("stock-name").value.trim();
      const start = document.getElementById("start-time").value;
      const end = document.getElementById("end-time").value;

      const params = new URLSearchParams();
      if (start) params.append("start_time", new Date(start).toISOString());
      if (end) params.append("end_time", new Date(end).toISOString());

      try {
        // Fetch price points
        const pricesRes = await fetch(`/api/prices/${stock}?${params.toString()}`);
        const pricesData = await pricesRes.json();

        if (!pricesRes.ok) throw new Error(pricesData.detail || `HTTP error ${pricesRes.status}`);

        results.innerHTML = "";

        if (!Array.isArray(pricesData) || pricesData.length === 0) {
          results.innerHTML = "<li>No results found.</li>";
        } else {
          pricesData.forEach(point => {
            const li = document.createElement("li");
            li.textContent = `$${point.price} at ${new Date(point.timestamp).toLocaleString()}`;
            results.appendChild(li);
          });
        }

        // Fetch average price
        const avgRes = await fetch(`/api/average/${stock}?${params.toString()}`);
        const avgData = await avgRes.json();

        if (!avgRes.ok) throw new Error(avgData.detail || `HTTP error ${avgRes.status}`);

        if (avgData.average_price === null) {
          avgDisplay.textContent = "No data to calculate average.";
        } else {
          avgDisplay.textContent = `Average Price: $${avgData.average_price.toFixed(2)}`;
        }
      } catch (err) {
        results.innerHTML = `<li>Error: ${err.message}</li>`;
        avgDisplay.textContent = "";
      }
    });
  </script>
</body>
</html>
